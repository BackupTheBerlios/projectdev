#!/bin/bash

version=0.0.1

grubupdate()
{
	echo "Processing your menu.lst..." && sleep 2
	if [ -f /boot/grub/menu.lst ]; then
		echo >>/boot/grub/menu.lst
		echo "# Generated by splash_install $version" >>/boot/grub/menu.lst
		echo "# Edit these lines as you need" >>/boot/grub/menu.lst
		echo "title  Project dEv  $1 fbsplash" >>/boot/grub/menu.lst
		echo "       root   (hd0,2)" >>/boot/grub/menu.lst
		echo "       kernel (hd0,0)/vmlinuz26 root=/dev/hda3 ro video=vesafb:ywrap,mtrr vga=$3 splash=silent,theme:$1" >>/boot/grub/menu.lst
		echo "       initrd (hd0,0)/fbsplash-$1-$2" >>/boot/grub/menu.lst
	else
		echo "You don't have a /boot/grub/menu.lst file"
		exit 0
	fi
	echo "Installation of $1 theme was successful!"
	echo "You can now edit your new GRuB entry"
	exit 1
}

splashinst()
{
	echo "Looking for $1 theme in /etc/splash..." && sleep 2
	if [ `find /etc/splash -type d -maxdepth 1 -name $1` ]; then
		true
	else
		echo "There is no $1 in /etc/splash"
		exit 0
	fi
	echo "Looking for $2 config file..." && sleep 2
	if [ `find /etc/splash/$1 -name $2.cfg` ]; then
		true
	else
		echo "There is no config file available for this resolution"
		exit 0
	fi
	echo "Finding suitable VGA ($2-$3)..." && sleep 2
	case $2 in
	640x480)
		case $3 in
		256) VGA="0x301" ;;
		32K) VGA="0x310" ;;
		64K) VGA="0x311" ;;
		16M) VGA="0x312" ;;
		*) echo "$3 is not a valid color depth" 
		   exit 0 ;;
		esac
		;;
	800x600)
		case $3 in
		256) VGA="0x303" ;;
		32K) VGA="0x313" ;;
		64K) VGA="0x314" ;;
		16M) VGA="0x315" ;;
		*) echo "$3 is not a valid color depth" 
		   exit 0 ;;
		esac
		;;
	1024x768)
		case $3 in
		256) VGA="0x305" ;;
		32K) VGA="0x316" ;;
		64K) VGA="0x317" ;;
		16M) VGA="0x318" ;;
		*) echo "$3 is not a valid color depth" 
		   exit 0 ;;
		esac
		;;
	1280x1024)
		case $3 in
		256) VGA="0x307" ;;
		32K) VGA="0x319" ;;
		64K) VGA="0x31A" ;;
		16M) VGA="0x31B" ;;
		*) echo "$3 is not a valid color depth"
		   exit 0 ;;
		esac
		;;
	1600x1200)
		case $3 in
		256) VGA="0x31C" ;;
		32K) VGA="0x31D" ;;
		64K) VGA="0x31E" ;;
		16M) VGA="0x31F" ;;
		*) echo "$3 is not a valid color depth"
		   exit 0 ;;
		esac
		;;
	*)
		echo "There is no suitable VGA for $2 resolution"
		exit 0
		;;
	esac
	echo "Creating initramfs image for $1 theme..." && sleep 2
	splash_geninitramfs -v -g /boot/fbsplash-$1-$2 -r $2 $1
	grubupdate $1 $2 $VGA
}

splashversion()
{
	echo "       splash_install v$version"
	echo "       Copyright 2004 Amar Hadzihasanovic - Project dEv"
	echo
	echo "       This program may be freely redistributed under"
	echo "       the terms of the GNU General Public License v2"
	echo
}
   
splashhelp()
{
	echo "Usage: splash_install --theme <...> --resolution <...> --colors <...>"
	echo "       splash_install [option...]"
	echo "Creates an initrd image for fbsplash themes and automatically updates GRuB"
	echo
	echo "Options:"
	echo "  --theme         Choose fbsplash theme to install"
	echo "  --resolution    Choose framebuffer resolution"
	echo "  --colors        Choose color depth [256|32K|64K|16M]"
	echo "  --version       Output version information"
	echo "  --help          Display this help message"
	echo 
	echo "Report bugs on http://www.projectdev.org"
}

while [ "$#" != "0" ]; do
	case $1 in
	--version)
		splashversion
		exit 0
		;;
	--help)
		splashhelp
		exit 0
		;;
	--theme)
		THEME=$2
		;;
	--resolution) 
		RESOLUTION=$2
		;;
	--colors) 
		COLORS=$2
		;;
	esac
	shift
done

if [ "$THEME" = "" ]; then
	splashhelp
	exit 0
elif [ "$RESOLUTION" = "" ]; then
	splashhelp
	exit 0
elif [ "$COLORS" = "" ]; then
	splashhelp
	exit 0
else
	splashinst $THEME $RESOLUTION $COLORS
fi
